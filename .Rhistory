bc_resist_10 <-  bc_data_phyto %>%
dplyr::filter(Day == 10)
bc_resist_10 <- bc_resist_10 %>%
mutate(resist= ((bc_resist_10$mean_bc-bc_resist_10$mean_bc_control)/bc_resist_10$mean_bc_control))
# plot resistance
Y_min<-min(c(bc_resist_10$resist),na.rm = T)-0.001
Y_max<-max(c(bc_resist_10$resist),na.rm = T)+0.001
# Since resistence was calculated in relation to the control, we are going to exculde the controls,
# but we put a line with y = 0 which is the benchmark for control values
plot_resistance_10 <- bc_resist_10
bc_resist_24 <-  bc_data_phyto %>%
dplyr::filter(Day == 24)
bc_resist_24 <- bc_resist_24 %>%
mutate(resist= ((bc_resist_24$mean_bc-bc_resist_24$mean_bc_control)/bc_resist_24$mean_bc_control))
# Since resistence was calculated in relation to the control, we are going to exculde the controls,
# but we put a line with y = 0 which is the benchmark for control values
plot_resistance_24 <- bc_resist_24
bc_resist_38 <-  bc_data_phyto %>%
dplyr::filter(Day == 38)
bc_resist_38 <- bc_resist_38 %>%
mutate(resist= ((bc_resist_38$mean_bc-bc_resist_38$mean_bc_control)/bc_resist_38$mean_bc_control))
# Since resistence was calculated in relation to the control, we are going to exculde the controls,
# but we put a line with y = 0 which is the benchmark for control values
plot_resistance_38 <- bc_resist_38
plot_resitance <- rbind(bc_resist_10, bc_resist_24, bc_resist_38)
# plot resistance
Y_min<-min(c(plot_resitance$resist),na.rm = T)-0.001
Y_max<-max(c(plot_resitance$resist),na.rm = T)+0.001
ggplot(data = plot_resitance,
mapping = aes(x = Treatment, y = resist, fill = Treatment)) +
ylab("Compositional Difference") +
xlab("") +
theme_bw() +
facet_wrap(~ Day, scales = "fixed") +
theme(text = element_text(size = 16),
axis.text = element_text(colour = "black"),
strip.background = element_blank(),
legend.position = "bottom") +
geom_point(position = position_jitter(width = 0.35), size = 2, show.legend = FALSE) +
geom_boxplot(alpha = 0.6) +
geom_abline(intercept=0, slope=0, linetype="dashed") +
scale_shape_manual(values = c(16,17), guide=FALSE) +
scale_fill_viridis_d(end = 0.8, begin = 0.1, option = "magma", guide=FALSE) +
scale_y_continuous(limits = c(Y_min, Y_max), breaks = pretty_breaks(n = 7))
# Plotting difference from control after each HW
# Example y-axis limits for demonstration; adjust these based on your data
Y_min <- -1
Y_max <- 0.75
# Define your plots (assuming plot_resistance_38, plot_resistance_24, and plot_resistance_10 datasets are available)
plot_resistance_38 <- ggplot(data = plot_resistance_38,
mapping = aes(x = Treatment, y = resist, fill = Treatment)) +
ylab("Compositional Difference D38") +
xlab("") +
theme_classic() +
theme(text = element_text(size = 16),
axis.text = element_text(colour = "black"),
strip.background = element_blank(),
legend.position = "bottom") +
geom_point(position = position_jitter(width = 0.35), size = 2, show.legend = FALSE) +
geom_boxplot(alpha = 0.6) +
geom_abline(intercept=0, slope=0, linetype="dashed") +
scale_shape_manual(values = c(16,17), guide=FALSE) +
scale_fill_viridis_d(end = 0.8, begin = 0.1, option = "magma", guide=FALSE) +
scale_y_continuous(limits = c(Y_min, Y_max), breaks = pretty_breaks(n = 7))
plot_resistance_24 <- ggplot(data = plot_resistance_24,
mapping = aes(x = Treatment, y = resist, fill = Treatment)) +
ylab("Compositional Difference D24") +
xlab("") +
theme_classic() +
theme(text = element_text(size = 16),
axis.text = element_text(colour = "black"),
strip.background = element_blank(),
legend.position = "bottom") +
geom_point(position = position_jitter(width = 0.35), size = 2, show.legend = FALSE) +
geom_boxplot(alpha = 0.6) +
geom_abline(intercept=0, slope=0, linetype="dashed") +
scale_shape_manual(values = c(16,17), guide=FALSE) +
scale_fill_viridis_d(end = 0.8, begin = 0.1, option = "magma", guide=FALSE) +
scale_y_continuous(limits = c(Y_min, Y_max), breaks = pretty_breaks(n = 7))
plot_resistance_10 <- ggplot(data = plot_resistance_10,
mapping = aes(x = Treatment, y = resist, fill = Treatment)) +
ylab("Compositional Difference D10") +
xlab("") +
theme_classic() +
theme(text = element_text(size = 16),
axis.text = element_text(colour = "black"),
strip.background = element_blank(),
legend.position = "bottom") +
geom_point(position = position_jitter(width = 0.35), size = 2, show.legend = FALSE) +
geom_boxplot(alpha = 0.6) +
geom_abline(intercept=0, slope=0, linetype="dashed") +
scale_shape_manual(values = c(16,17), guide=FALSE) +
scale_fill_viridis_d(end = 0.8, begin = 0.1, option = "magma", guide=FALSE) +
scale_y_continuous(limits = c(Y_min, Y_max), breaks = pretty_breaks(n = 7))
# Combine the plots
combined_plot <- plot_resistance_38 + plot_resistance_24 + plot_resistance_10 +
plot_layout(ncol = 3)
print(combined_plot)
# select control as reference
control_bc <- tot.bio %>%
filter(Treatment == "Control") %>%
group_by(Day) %>%
dplyr::summarize(mean_bc_control = mean(tot.bio_log, na.rm = T))
# select all other treatments
bc_all_treat <- tot.bio %>%
group_by(Day, Mesocosm.No, Treatment, Long.treatment) %>%
dplyr::summarize(mean_bc = mean(tot.bio_log, na.rm = T))
bc_data_phyto <- merge(bc_all_treat, control_bc, by = "Day")
# resistance defined as the difference between stressed and control divided by the control (i.e. Pennekamp et al 2018)
bc_data_phyto <- bc_data_phyto %>% filter(Treatment != "Long")
bc_resist_10 <-  bc_data_phyto %>%
dplyr::filter(Day == 10)
bc_resist_10 <- bc_resist_10 %>%
mutate(resist= ((bc_resist_10$mean_bc-bc_resist_10$mean_bc_control)/bc_resist_10$mean_bc_control))
# plot resistance
Y_min<-min(c(bc_resist_10$resist),na.rm = T)-0.001
Y_max<-max(c(bc_resist_10$resist),na.rm = T)+0.001
# Since resistence was calculated in relation to the control, we are going to exculde the controls,
# but we put a line with y = 0 which is the benchmark for control values
plot_resistance_10 <- bc_resist_10
bc_resist_24 <-  bc_data_phyto %>%
dplyr::filter(Day == 24)
bc_resist_24 <- bc_resist_24 %>%
mutate(resist= ((bc_resist_24$mean_bc-bc_resist_24$mean_bc_control)/bc_resist_24$mean_bc_control))
# Since resistence was calculated in relation to the control, we are going to exculde the controls,
# but we put a line with y = 0 which is the benchmark for control values
plot_resistance_24 <- bc_resist_24
bc_resist_38 <-  bc_data_phyto %>%
dplyr::filter(Day == 38)
bc_resist_38 <- bc_resist_38 %>%
mutate(resist= ((bc_resist_38$mean_bc-bc_resist_38$mean_bc_control)/bc_resist_38$mean_bc_control))
# Since resistence was calculated in relation to the control, we are going to exculde the controls,
# but we put a line with y = 0 which is the benchmark for control values
plot_resistance_38 <- bc_resist_38
plot_resitance <- rbind(bc_resist_10, bc_resist_24, bc_resist_38)
# plot resistance
Y_min<-min(c(plot_resitance$resist),na.rm = T)-0.001
Y_max<-max(c(plot_resitance$resist),na.rm = T)+0.001
ggplot(data = plot_resitance,
mapping = aes(x = Treatment, y = resist, fill = Treatment)) +
ylab("Compositional Difference") +
xlab("") +
theme_bw() +
facet_wrap(~ Day, scales = "fixed") +
theme(text = element_text(size = 16),
axis.text = element_text(colour = "black"),
strip.background = element_blank(),
legend.position = "bottom") +
geom_point(position = position_jitter(width = 0.35), size = 2, show.legend = FALSE) +
geom_boxplot(alpha = 0.6) +
geom_abline(intercept=0, slope=0, linetype="dashed") +
scale_shape_manual(values = c(16,17), guide=FALSE) +
scale_fill_viridis_d(end = 0.8, begin = 0.1, option = "magma", guide=FALSE) +
scale_y_continuous(limits = c(Y_min, Y_max), breaks = pretty_breaks(n = 7))
# Plotting difference from control after each HW
# Example y-axis limits for demonstration; adjust these based on your data
Y_min<-min(c(plot_resitance$resist),na.rm = T)-0.001
Y_max<-max(c(plot_resitance$resist),na.rm = T)+0.001
# Define your plots (assuming plot_resistance_38, plot_resistance_24, and plot_resistance_10 datasets are available)
plot_resistance_38 <- ggplot(data = plot_resistance_38,
mapping = aes(x = Treatment, y = resist, fill = Treatment)) +
ylab("Compositional Difference D38") +
xlab("") +
theme_classic() +
theme(text = element_text(size = 16),
axis.text = element_text(colour = "black"),
strip.background = element_blank(),
legend.position = "bottom") +
geom_point(position = position_jitter(width = 0.35), size = 2, show.legend = FALSE) +
geom_boxplot(alpha = 0.6) +
geom_abline(intercept=0, slope=0, linetype="dashed") +
scale_shape_manual(values = c(16,17), guide=FALSE) +
scale_fill_viridis_d(end = 0.8, begin = 0.1, option = "magma", guide=FALSE) +
scale_y_continuous(limits = c(Y_min, Y_max), breaks = pretty_breaks(n = 7))
plot_resistance_24 <- ggplot(data = plot_resistance_24,
mapping = aes(x = Treatment, y = resist, fill = Treatment)) +
ylab("Compositional Difference D24") +
xlab("") +
theme_classic() +
theme(text = element_text(size = 16),
axis.text = element_text(colour = "black"),
strip.background = element_blank(),
legend.position = "bottom") +
geom_point(position = position_jitter(width = 0.35), size = 2, show.legend = FALSE) +
geom_boxplot(alpha = 0.6) +
geom_abline(intercept=0, slope=0, linetype="dashed") +
scale_shape_manual(values = c(16,17), guide=FALSE) +
scale_fill_viridis_d(end = 0.8, begin = 0.1, option = "magma", guide=FALSE) +
scale_y_continuous(limits = c(Y_min, Y_max), breaks = pretty_breaks(n = 7))
plot_resistance_10 <- ggplot(data = plot_resistance_10,
mapping = aes(x = Treatment, y = resist, fill = Treatment)) +
ylab("Compositional Difference D10") +
xlab("") +
theme_classic() +
theme(text = element_text(size = 16),
axis.text = element_text(colour = "black"),
strip.background = element_blank(),
legend.position = "bottom") +
geom_point(position = position_jitter(width = 0.35), size = 2, show.legend = FALSE) +
geom_boxplot(alpha = 0.6) +
geom_abline(intercept=0, slope=0, linetype="dashed") +
scale_shape_manual(values = c(16,17), guide=FALSE) +
scale_fill_viridis_d(end = 0.8, begin = 0.1, option = "magma", guide=FALSE) +
scale_y_continuous(limits = c(Y_min, Y_max), breaks = pretty_breaks(n = 7))
# Combine the plots
combined_plot <- plot_resistance_38 + plot_resistance_24 + plot_resistance_10 +
plot_layout(ncol = 3)
print(combined_plot)
# Combine the plots
combined_plot <- plot_resistance_10 + plot_resistance_24 + plot_resistance_38 +
plot_layout(ncol = 3)
print(combined_plot)
Resistance ###
# select control as reference
control_bc <- Bray_Curtis_distances_phyto %>%
filter(Treatment == "Control") %>%
group_by(Day) %>%
dplyr::summarize(mean_bc_control = mean(BC_meanC_all, na.rm = T))
# select all other treatments
bc_all_treat <- Bray_Curtis_distances_phyto %>%
group_by(Day, Sample, Treatment, Heat.treatment, Warm.treatment, Ins.treatment) %>%
dplyr::summarize(mean_bc = mean(BC_meanC_all, na.rm = T))
bc_data_phyto <- merge(bc_all_treat, control_bc, by = "Day")
# resistance defined as the difference between stressed and control divided by the control (i.e. Pennekamp et al 2018)
bc_data_phyto <- bc_data_phyto %>% filter(Treatment != "E/C0")
bc_resist_10 <-  bc_data_phyto %>%
dplyr::filter(Day == 10)
bc_resist_10 <- bc_resist_10 %>%
mutate(resist= ((bc_resist_10$mean_bc-bc_resist_10$mean_bc_control)/bc_resist_10$mean_bc_control)*-1)
# plot resistance
Y_min<-min(c(bc_resist_10$resist),na.rm = T)-0.001
Y_max<-max(c(bc_resist_10$resist),na.rm = T)+0.001
# Since resistence was calculated in relation to the control, we are going to exculde the controls,
# but we put a line with y = 0 which is the benchmark for control values
plot_resistance_10 <- bc_resist_10
bc_resist_24 <-  bc_data_phyto %>%
dplyr::filter(Day == 24)
bc_resist_24 <- bc_resist_24 %>%
mutate(resist= ((bc_resist_24$mean_bc-bc_resist_24$mean_bc_control)/bc_resist_24$mean_bc_control)*-1)
# Since resistence was calculated in relation to the control, we are going to exculde the controls,
# but we put a line with y = 0 which is the benchmark for control values
plot_resistance_24 <- bc_resist_24
bc_resist_38 <-  bc_data_phyto %>%
dplyr::filter(Day == 38)
bc_resist_38 <- bc_resist_38 %>%
mutate(resist= ((bc_resist_38$mean_bc-bc_resist_38$mean_bc_control)/bc_resist_38$mean_bc_control)*-1)
# Since resistence was calculated in relation to the control, we are going to exculde the controls,
# but we put a line with y = 0 which is the benchmark for control values
plot_resistance_38 <- bc_resist_38
plot_resitance <- rbind(bc_resist_10, bc_resist_24, bc_resist_38)
# plot resistance
Y_min<-min(c(plot_resitance$resist),na.rm = T)-0.001
Y_max<-max(c(plot_resitance$resist),na.rm = T)+0.001
ggplot(data = plot_resitance,
mapping = aes(x = Treatment, y = resist, fill = Treatment)) +
ylab("Compositional Difference") +
xlab("") +
theme_bw() +
facet_wrap(~ Day, scales = "fixed") +
theme(text = element_text(size = 16),
axis.text = element_text(colour = "black"),
strip.background = element_blank(),
legend.position = "bottom") +
geom_point(position = position_jitter(width = 0.35), size = 2, show.legend = FALSE) +
geom_boxplot(alpha = 0.6) +
geom_abline(intercept=0, slope=0, linetype="dashed") +
scale_shape_manual(values = c(16,17), guide=FALSE) +
scale_fill_viridis_d(end = 0.8, begin = 0.1, option = "magma", guide=FALSE) +
scale_y_continuous(limits = c(Y_min, Y_max), breaks = pretty_breaks(n = 7))
# Plotting difference from control after each HW
# Example y-axis limits for demonstration; adjust these based on your data
Y_min <- -1
Y_max <- 0.75
# Define your plots (assuming plot_resistance_38, plot_resistance_24, and plot_resistance_10 datasets are available)
plot_resistance_38 <- ggplot(data = plot_resistance_38,
mapping = aes(x = Treatment, y = resist, fill = Treatment)) +
ylab("Compositional Difference D38") +
xlab("") +
theme_classic() +
theme(text = element_text(size = 16),
axis.text = element_text(colour = "black"),
strip.background = element_blank(),
legend.position = "bottom") +
geom_point(position = position_jitter(width = 0.35), size = 2, show.legend = FALSE) +
geom_boxplot(alpha = 0.6) +
geom_abline(intercept=0, slope=0, linetype="dashed") +
scale_shape_manual(values = c(16,17), guide=FALSE) +
scale_fill_viridis_d(end = 0.8, begin = 0.1, option = "magma", guide=FALSE) +
scale_y_continuous(limits = c(Y_min, Y_max), breaks = pretty_breaks(n = 7))
plot_resistance_24 <- ggplot(data = plot_resistance_24,
mapping = aes(x = Treatment, y = resist, fill = Treatment)) +
ylab("Compositional Difference D24") +
xlab("") +
theme_classic() +
theme(text = element_text(size = 16),
axis.text = element_text(colour = "black"),
strip.background = element_blank(),
legend.position = "bottom") +
geom_point(position = position_jitter(width = 0.35), size = 2, show.legend = FALSE) +
geom_boxplot(alpha = 0.6) +
geom_abline(intercept=0, slope=0, linetype="dashed") +
scale_shape_manual(values = c(16,17), guide=FALSE) +
scale_fill_viridis_d(end = 0.8, begin = 0.1, option = "magma", guide=FALSE) +
scale_y_continuous(limits = c(Y_min, Y_max), breaks = pretty_breaks(n = 7))
plot_resistance_10 <- ggplot(data = plot_resistance_10,
mapping = aes(x = Treatment, y = resist, fill = Treatment)) +
ylab("Compositional Difference D10") +
xlab("") +
theme_classic() +
theme(text = element_text(size = 16),
axis.text = element_text(colour = "black"),
strip.background = element_blank(),
legend.position = "bottom") +
geom_point(position = position_jitter(width = 0.35), size = 2, show.legend = FALSE) +
geom_boxplot(alpha = 0.6) +
geom_abline(intercept=0, slope=0, linetype="dashed") +
scale_shape_manual(values = c(16,17), guide=FALSE) +
scale_fill_viridis_d(end = 0.8, begin = 0.1, option = "magma", guide=FALSE) +
scale_y_continuous(limits = c(Y_min, Y_max), breaks = pretty_breaks(n = 7))
# Combine the plots
combined_plot <- plot_resistance_10 + plot_resistance_24 + plot_resistance_38 +
plot_layout(ncol = 3)
print(combined_plot)
library(terra)
remove.packages("terra")
rm(list = ls())
library(tidyverse)
library(readxl)
library(patchwork)
library(vegan)
library(emmeans)
library(lme4)
library(lmerTest)
library(performance)
library(knitr)
dd_abu <- read_excel("data/abundance_cosm.xlsx")
names(dd_abu)
tot.abu <- dd_abu[, c(1:6)]
tot.abu<-as.data.frame(tot.abu)
tot.abu$total.abu<- rowSums(dd_abu[, c(7:97)])
unique(tot.abu$Day)
### Log10 abundance
tot.abu$tot.abu_log <- log10(tot.abu$total.abu+1)
# Function to calculate standard error
se <- function(x) sqrt(var(x, na.rm = TRUE) / length(na.omit(x)))
# Calculate mean abundance and standard error for Control
control_mean <- tot.abu %>% filter(Treatment == "Control") %>%
group_by(Day) %>%
summarize(control_mean_abu = mean(tot.abu_log, na.rm = TRUE))
# Calculate differences from Control for each treatment
tot.abu_diff <- tot.abu %>%
left_join(control_mean, by = "Day") %>%
mutate(diff_abu = tot.abu_log - control_mean_abu)
# Summarize the data for plotting
tot_abu_dynamics <- tot.abu_diff %>%
group_by(Treatment, Day) %>%
summarize(mean_diff_abu = mean(diff_abu, na.rm = TRUE), se = se(diff_abu)) %>%
mutate(lower_y = mean_diff_abu - se, upper_y = mean_diff_abu + se)
# Determine the y-axis limits to ensure alignment of zero line
y_limits <- range(tot_abu_dynamics$mean_diff_abu + tot_abu_dynamics$se,
tot_abu_dynamics$mean_diff_abu - tot_abu_dynamics$se)
# Filter out the control treatment for the plot
tot_abu_dynamics_filtered <- tot_abu_dynamics %>% filter(Treatment == "HW/C0")
data_phyto_plot <- tot_abu_dynamics_filtered %>% filter(Day <= 38)
# Plot the data with faceting and aligned y-axis
abu_plot <- ggplot(data_phyto_plot, aes(x = Day, y = mean_diff_abu, color = Treatment, fill = Treatment)) +
geom_line(aes(group = Treatment), size = 1) +
geom_ribbon(aes(ymin = lower_y, ymax = upper_y, group = Treatment), alpha = 0.1, show.legend = FALSE) +
ylab("Phytoplankton \nDifference in abumass (ind/mesocosm)") +
xlab("Day") +
viridis::scale_colour_viridis(name = "Treatment", discrete = TRUE, end = 0.8, begin = 0.1, option = "inferno") +
viridis::scale_fill_viridis(name = "Treatment", discrete = TRUE, end = 0.8, begin = 0.1, option = "inferno") +
scale_x_continuous(limits = c(-5, 40)) +
theme(legend.position = "top") +
theme_bw() +
guides(fill = guide_legend(override.aes = list(size = 8), ncol = 6)) +
geom_hline(yintercept = 0, linetype = "dashed") +
facet_wrap(~ Treatment, scales = "fixed") +
coord_cartesian(ylim = y_limits)  # Set the y-axis limits to align the zero line
abu_plot
ggplot(data_phyto_plot, aes(x = Day, y = mean_diff_abu, color = Treatment, fill = Treatment)) +
geom_line(aes(group = Treatment), size = 1) +
geom_point()+
geom_ribbon(aes(ymin = lower_y, ymax = upper_y, group = Treatment), alpha = 0.1, show.legend = FALSE) +
ylab("Phytoplankton \nDifference in abumass (g/mesocosm)") +
xlab("Day") +
viridis::scale_colour_viridis(name = "Treatment", discrete = TRUE, end = 0.8, begin = 0.1, option = "inferno") +
viridis::scale_fill_viridis(name = "Treatment", discrete = TRUE, end = 0.8, begin = 0.1, option = "inferno") +
scale_x_continuous(limits = c(-5, 40)) +
theme(legend.position = "top") +
theme_bw() +
guides(fill = guide_legend(override.aes = list(size = 8), ncol = 6)) +
geom_hline(yintercept = 0, linetype = "dashed") +
coord_cartesian(ylim = y_limits) +  # Set the y-axis limits to align the zero line
annotate("rect", xmin = 0, xmax = 6, ymin = -Inf, ymax = Inf, alpha = 0.1, fill = "red") +
annotate("rect", xmin = 14, xmax = 20, ymin = -Inf, ymax = Inf, alpha = 0.1, fill = "red") +
annotate("rect", xmin = 28, xmax = 34, ymin = -Inf, ymax = Inf, alpha = 0.1, fill = "red")+
theme(legend.position = "none")
dd_abu
str(dd_abu)
groups <- read_excel("data/DataMesocosms2021.xlsx",
sheet = "Phytoplankton counting")
names(groups)
groups <- groups[-c(1:5), c(2,4)]
groups
names(groups)
groups <- groups %>% rename(group = "...2",
species = "UNIT cell/mL")
dd_abu <- read_excel("data/abundance_cosm.xlsx")
dd_abu1
groups
dd_abu
dd_abu_long <- dd_abu %>%
pivot_longer(
cols = -c(Sample, Treatment, Day, Heat.treatment, Warm.treatment, Ins.treatment),
names_to = "species",
values_to = "abundance"
)
# Merge with groups by species names
merged_data <- dd_abu_long %>%
left_join(groups, by = "species")
# Calculate the abundance by group for each day/treatment/sample
group_abundance <- merged_data %>%
group_by(Sample, Treatment, Day, Heat.treatment, Warm.treatment, Ins.treatment, group) %>%
summarise(total_abundance = sum(abundance, na.rm = TRUE), .groups = "drop")
# Transform back into wide format
group_abundance_wide <- group_abundance %>%
pivot_wider(
names_from = group,
values_from = total_abundance,
values_fill = 0  # Fill missing values with 0
)
# View the final wide format data
print(group_abundance_wide)
# Calculate the relative abundance by group for each sample
relative_abundance <- group_abundance %>%
group_by(Sample, Treatment, Day, Heat.treatment, Warm.treatment, Ins.treatment) %>%
mutate(total_abundance = sum(total_abundance, na.rm = TRUE)) %>%
ungroup() %>%
mutate(relative_abundance = total_abundance / total_abundance)
# Transform into long format for plotting
relative_abundance_long <- relative_abundance %>%
pivot_longer(
cols = -c(Sample, Treatment, Day, Heat.treatment, Warm.treatment, Ins.treatment, total_abundance),
names_to = "group",
values_to = "relative_abundance"
)
# Calculate the relative abundance by group for each sample
relative_abundance <- group_abundance %>%
group_by(Sample, Treatment, Day, Heat.treatment, Warm.treatment, Ins.treatment) %>%
mutate(total_abundance_sample = sum(total_abundance, na.rm = TRUE)) %>%
ungroup() %>%
mutate(relative_abundance = total_abundance / total_abundance_sample)
# Transform into long format for plotting
relative_abundance_long <- relative_abundance %>%
pivot_longer(
cols = -c(Sample, Treatment, Day, Heat.treatment, Warm.treatment, Ins.treatment, total_abundance_sample, relative_abundance),
names_to = "group",
values_to = "abundance"
) %>%
mutate(relative_abundance = abundance / total_abundance_sample)
names(group_abundance)
names(group_abundance_wide)
group_abundance_wide <- group_abundance_wide[, c(1:3, 7:15)]
group_abundance_wide
str(group_abundance_wide)
# Calculate the relative abundance by group for each sample
relative_abundance <- group_abundance_wide %>%
rowwise() %>%
mutate(total_abundance = sum(c_across(Bacillariophyta:Synurophyta), na.rm = TRUE)) %>%
ungroup() %>%
mutate(across(Bacillariophyta:Synurophyta, ~ . / total_abundance, .names = "rel_{.col}"))
# Transform into long format for plotting
relative_abundance_long <- relative_abundance %>%
pivot_longer(
cols = starts_with("rel_"),
names_to = "group",
names_prefix = "rel_",
values_to = "relative_abundance"
)
# Create the bar plots
p <- ggplot(relative_abundance_long, aes(x = Treatment, y = relative_abundance, fill = group)) +
geom_bar(stat = "identity", position = "fill") +
facet_wrap(~ Day, scales = "free_x") +
labs(x = "Treatment", y = "Relative Abundance", fill = "Group") +
theme_minimal() +
theme(legend.position = "right")
# Print the plot
print(p)
# Log10 transform the abundance values (adding 1 to avoid log(0))
group_abundance_log <- group_abundance_wide %>%
mutate(across(starts_with(c("Bacillariophyta", "Charophyta", "Chlorophyta",
"Ciliophora", "Cryptophyta", "Cyanobacteria",
"Dinophyta", "Euglenophyta", "Synurophyta")),
~log10(. + 1)))
# Transform into long format for plotting
group_abundance_long <- group_abundance_log %>%
pivot_longer(
cols = -c(Sample, Treatment, Day),
names_to = "group",
values_to = "log10_abundance"
)
# Plot
ggplot(group_abundance_long, aes(x = Treatment, y = log10_abundance, fill = group)) +
geom_bar(stat = "identity", position = "stack") +
facet_wrap(~ Day, scales = "free_x") +
theme_minimal() +
labs(x = "Treatment", y = "Log10 Abundance", fill = "Group") +
theme(
text = element_text(size = 12),
axis.text.x = element_text(angle = 45, hjust = 1)
)
