"0","### Bray-Curtis dissimilarity calculation ###"
"0","dd_bray <- read_excel(""data/abundance_cosm.xlsx"")"
"0","dd_bray[is.na(dd_bray)] <- 0"
"0",""
"0","dd_bray <- as.data.frame(dd_bray)"
"0","dd_bray <- dd_bray %>% filter(Treatment %in% c(""HW/C0"", ""Control""),"
"0","                              Day <= 38)"
"0","days_FR <- unique(dd_bray$Day)"
"0",""
"0",""
"0",""
"0","# Include running index ""m"", set it to 1 "
"0",""
"0","m <- 1"
"0",""
"0",""
"0",""
"0","for (j in 1:length(days_FR)){  ## inner loop for days"
"0","  "
"0","  # Extract data for one single day"
"0","  "
"0","  mysite <- dd_bray %>% "
"0","    filter( Day == days_FR[j])"
"0","  "
"0","  # Add row names to the data frame, useful later for the Bray-Curtis calculation"
"0","  "
"0","  rownames(mysite) <- paste(mysite$Treatment, mysite$Sample, mysite$Day, sep = ""_"")"
"0","  "
"0","  # Extract controls "
"0","  "
"0","  control_cosm <- mysite %>% "
"0","    filter(Treatment == ""Control"")"
"0","  "
"0","  # Calculate average community composition (average abundance of each group/column)"
"0","  # Important: only columns with species are included "
"0","  # ref.comm.all => includes all species"
"0","  "
"0","  "
"0","  ref.comm.all <- control_cosm[,c(7:97)] %>% summarise_each(funs( mean( .,na.rm = TRUE)))"
"0","  rownames(ref.comm.all) <- ""REF.COMM.ALL"""
"0","  "
"0","  "
"0","  # Add the reference community to your site"
"0","  "
"0","  z.all <- rbind(mysite[,c(7:97)], ref.comm.all)"
"0","  "
"0","  # Calculate Bray-Curtis Dissimilarity using the function vegdist"
"0","  "
"0","  # Matrix of all Bray-Curtis Dissimilarities"
"0","  "
"0","  calc.BC.all <- as.matrix(vegdist(z.all, method = ""bray"", binary = F, na.rm = T))"
"0","  "
"0","  # Extract just the last column containing the pairwise comparison of each plot "
"0","  # to the average control community composition"
"0","  "
"0","  BC.mean.C.all <- calc.BC.all[1:8,""REF.COMM.ALL""]"
"0","  "
"0","  "
"0","  # Add the BCs to the mysite dataset"
"0","  "
"0","  mysite$BC_meanC_all <- BC.mean.C.all"
"0","  "
"0","  "
"0","  # This is optional: add the names from the BC vectors to mysite "
"0","  # to be sure you extracted the correct comparions of single communities to REF.COMM."
"0","  "
"0","  mysite$community_all <- names(BC.mean.C.all)"
"0","  "
"0","  "
"0","  if (m == 1){"
"0","    df.sites <- mysite"
"0","  }"
"0","  "
"0","  if (m > 1){"
"0","    df.sites <- rbind(df.sites,mysite)"
"0","  }"
"0","  "
"0","  # Increase m (the running index) by 1"
"0","  "
"0","  m <- m + 1"
"0","}"
"0",""
"0","df.sites_phyto <-  df.sites "
"0",""
"0",""
"0","Bray_Curtis_distances_phyto <- df.sites_phyto[,c(1:6,98:99)]"
"0",""
"0",""
"0",""
"0","# Function to calculate standard error"
"0","se <- function(x) sqrt(var(x, na.rm = TRUE) / length(na.omit(x)))"
"0",""
"0","# Calculate mean abundance and standard error for Control"
"0","control_mean_bray <- Bray_Curtis_distances_phyto %>% filter(Treatment == ""Control"") %>%"
"0","  group_by(Day) %>%"
"0","  summarize(control_mean_bray = mean(BC_meanC_all, na.rm = TRUE))"
"0",""
"0","# Calculate differences from Control for each treatment"
"0","tot.bray_diff <- Bray_Curtis_distances_phyto %>%"
"0","  left_join(control_mean_bray, by = ""Day"") %>%"
"0","  mutate(diff_bray = BC_meanC_all - control_mean_bray)"
"0",""
"0","# Summarize the data for plotting"
"0","tot_bray_dynamics <- tot.bray_diff %>%"
"0","  group_by(Treatment, Day) %>%"
"0","  summarize(mean_diff_bray = mean(diff_bray, na.rm = TRUE), se = se(diff_bray)) %>%"
"0","  mutate(lower_y = mean_diff_bray - se, upper_y = mean_diff_bray + se)"
"1","[38;5;250m`summarise()` has grouped output by 'Treatment'. You can override using the `.groups` argument.[39m
"
"0","tot_bray_dynamics <- tot_bray_dynamics %>% mutate(mean_diff_bray = (mean_diff_bray* -1),"
"0","                                                  lower_y = (lower_y * -1),"
"0","                                                  upper_y = (upper_y * -1))"
"0",""
"0","# Determine the y-axis limits to ensure alignment of zero line"
"0","y_limits <- range(tot_bray_dynamics$mean_diff_bray + tot_bray_dynamics$se, "
"0","                  tot_bray_dynamics$mean_diff_bray - tot_bray_dynamics$se)"
"0",""
"0","# Filter out the control treatment for the plot"
"0","# tot_bray_dynamics_filtered <- tot_bray_dynamics %>% filter(Treatment == ""HW/C0"")"
"0","# data_bray <- tot_bray_dynamics_filtered %>% filter(Day <= 38)"
"0",""
"0","bray_plot <- ggplot(tot_bray_dynamics, aes(x = Day, y = mean_diff_bray, color = Treatment, fill = Treatment)) +"
"0","  geom_line(aes(group = Treatment), size = 1) +"
"0","  geom_point()+"
"0","  geom_ribbon(aes(ymin = lower_y, ymax = upper_y, group = Treatment), alpha = 0.1, show.legend = FALSE) +"
"0","  ylab(""Phytoplankton \nDifference in Bray - Curtis dissimilarity"") +"
"0","  xlab(""Day"") +"
"0","  viridis::scale_colour_viridis(name = ""Treatment"", discrete = TRUE, end = 0.8, begin = 0.1, option = ""inferno"") +"
"0","  viridis::scale_fill_viridis(name = ""Treatment"", discrete = TRUE, end = 0.8, begin = 0.1, option = ""inferno"") +"
"0","  scale_x_continuous(limits = c(-5, 40)) +"
"0","  theme(legend.position = ""top"") +"
"0","  theme_bw() +"
"0","  guides(fill = guide_legend(override.aes = list(size = 8), ncol = 6)) +"
"0","  geom_hline(yintercept = 0, linetype = ""dashed"") +"
"0","  coord_cartesian(ylim = y_limits) +  # Set the y-axis limits to align the zero line"
"0","  annotate(""rect"", xmin = 0, xmax = 6, ymin = -Inf, ymax = Inf, alpha = 0.1, fill = ""red"") +"
"0","  annotate(""rect"", xmin = 14, xmax = 20, ymin = -Inf, ymax = Inf, alpha = 0.1, fill = ""red"") +"
"0","  annotate(""rect"", xmin = 28, xmax = 34, ymin = -Inf, ymax = Inf, alpha = 0.1, fill = ""red"") +"
"0","  theme(legend.position = ""none"")"
"0",""
