---
title: "Slowing down in recovery of phytoplankton community due to recurrent heatwaves"
author: "Francesco Polazzo"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    code_folding: hide
    keep_md: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r include = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      include = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE)
```

```{r results='hide'}
rm(list = ls())
library(tidyverse)
library(readxl)
library(patchwork)
library(vegan)
library(emmeans)
library(lme4)
library(lmerTest)
library(performance)
library(knitr)
library(kableExtra)
library(officer)
library(flextable)
library(broom.mixed)
library(lubridate)
library(RColorBrewer)

```

# Introduction

With this article we wanted to test two major ecological framework that are commonly applied to systems facing repeated perturbations: 

- Critical slowing down (https://www.journals.uchicago.edu/doi/full/10.1086/516845) (https://www.nature.com/articles/nature10723)

- Community rescue (https://www.nature.com/articles/s41559-020-1134-5)

For this we used data coming from an outdoor pond mesocosm experiment (2021 Spain) where a semi-natural phytoplankton community was exposed to three subsequent heatwaves. Heatwaves are becoming more frequent and more intense, rising concerns about whether and how natural communities can face these perturbations and keep performing their functions. Critically, increasing research is suggesting that heatwaves can cause ecological systems to transition.

This transitions, also called tipping points, represent particular points at which complex systems can shift abruptly from one state to another, and they are notoriously difficult to predict.
Attention has thus turned to inferring process from pattern – identifying phenomenological signals in measurable aspect of a biological system that indicates shifts in the under-lying processes that may alter the structure and function of the system. A key development in the search for such pattern-based indicators is early warning signals (EWSs) derived from dynamic systems theory (all Scheffer's papers)

Theory proposes that early warning signals may be based on the phenomenon that recovery rates from perturbations should tend to zero when approaching a tipping point. However, evidence that this happens in living systems is scarce (at best).



Community rescue occurs when ecological or evolutionary processes restore positive growth in a highly stressful environment that was lethal to the community in its ancestral form, thus averting biomass collapse in a deteriorating environment. Very few empirical examples exist about community rescue, yet it is though to be one key mechanism that increases stress resistance in communities and contribute maintaining aggregate community properties such as biomass under stressful conditions.

Here we test whether a semi-natural phytoplankton community undergoing repeated heatwave perturbation shows signs of critical slowing down or community rescue. 



# Results
## Water temperature time series
```{r temperature_plot, fig.cap='Water temperature dynamics over time.', fig.align="center", fig.height=6, fig.width=10}


# Combine the datasets
combined_data<- read.csv("data/hobo_recordings.csv")


## Plot only data relevant for the experiment
filtered_combined_data <- combined_data %>%
  filter(DateTime <= as.POSIXct("2021-06-15 23:59:59"))


# Plot temperature over time with explicit grouping by Treatment
temperature_plot <- ggplot(filtered_combined_data, aes(x = DateTime, y = Temp, color = Treatment, group = Treatment)) +
  geom_line(size = 1) +
  labs(title = "",
       x = "Date",
       y = "Temperature (°C)",
       color = "Treatment") +
  theme_bw(base_size = 20) +  # White background theme
  scale_color_viridis_d(option = "C", end = 0.8) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 24, face = "bold"),
    axis.title.x = element_text(size = 22, face = "bold"),
    axis.title.y = element_text(size = 22, face = "bold"),
    axis.text = element_text(size = 20),
    legend.position = "top",
    legend.title = element_text(size = 20, face = "bold"),
    legend.text = element_text(size = 18)
  )

# Display the plot
print(temperature_plot)

```
The water temperature manipulation using the TENTACLE machinery [https://www.sciencedirect.com/science/article/pii/S2468067222000529] worked quite well. 

## Ecosystem functioning endpoints

### Dissolved oxygen 

```{r results='hide', echo = FALSE}

# Function to calculate standard error
se <- function(x) sqrt(var(x, na.rm = TRUE) / length(na.omit(x)))


ox <- read.csv("data/oxygen.csv")


# Calculate mean abundance and standard error for Control
control_mean <- ox %>% filter(Treatment == "Control") %>%
  group_by(Day) %>%
  summarize(control_mean_ox = mean(ox, na.rm = TRUE))

# Calculate differences from Control for each treatment
tot.ox_diff <- ox %>%
  left_join(control_mean, by = "Day") %>%
  mutate(diff_ox = ox - control_mean_ox)

# Summarize the data for plotting
tot_ox_dynamics <- tot.ox_diff %>%
  group_by(Treatment, Day) %>%
  summarize(mean_diff_ox = mean(diff_ox, na.rm = TRUE), se = se(diff_ox)) %>%
  mutate(lower_y = mean_diff_ox - se, upper_y = mean_diff_ox + se)

# Determine the y-axis limits to ensure alignment of zero line
y_limits <- range(tot_ox_dynamics$mean_diff_ox + tot_ox_dynamics$se, 
                  tot_ox_dynamics$mean_diff_ox - tot_ox_dynamics$se)

# Filter out the control treatment for the plot
tot_ox_dynamics_filtered <- tot_ox_dynamics %>% filter(Treatment == "HW")


ox_plot <- ggplot(tot_ox_dynamics_filtered, aes(x = Day, y = mean_diff_ox, color = Treatment, fill = Treatment)) +
  geom_line(aes(group = Treatment), size = 1, color = "blue") +
  geom_point(size = 2, color = "blue") +
  geom_ribbon(aes(ymin = lower_y, ymax = upper_y, group = Treatment), alpha = 0.1, show.legend = FALSE, fill = "blue", color = "blue") +
  ylab("Dissolved oxygen \nDifference in mg/L") +
  xlab("Day") +
  viridis::scale_colour_viridis(name = "Treatment", discrete = TRUE, end = 0.8, begin = 0.1, option = "inferno") +
  viridis::scale_fill_viridis(name = "Treatment", discrete = TRUE, end = 0.8, begin = 0.1, option = "inferno") +
  scale_x_continuous(limits = c(-5, 40)) +
  theme_bw() +
  theme(legend.position = "none",                   # Remove legend
  text = element_text(size = 20),             # Increase text size for all text elements
        axis.title = element_text(size = 22),       # Increase axis title size
        plot.title = element_text(size = 24),       # Increase plot title size
        axis.text = element_text(size = 20),        # Increase axis text size
        axis.line = element_line(size = 0.5),       # Adjust axis line thickness
        panel.grid.major = element_blank(),         # Remove major gridlines
        panel.grid.minor = element_blank(),         # Remove minor gridlines
        panel.border = element_blank(),            # Remove panel borders
        panel.background = element_blank()) +      # Remove panel background

  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_cartesian(ylim = y_limits) + 
  annotate("rect", xmin = 0, xmax = 6, ymin = -Inf, ymax = Inf, alpha = 0.3, fill = "red") +
  annotate("rect", xmin = 14, xmax = 20, ymin = -Inf, ymax = Inf, alpha = 0.3, fill = "red") +
  annotate("rect", xmin = 28, xmax = 34, ymin = -Inf, ymax = Inf, alpha = 0.3, fill = "red") + labs(tag = "(a)")

```
Oxygen shows an impaired recovery after the third heatwave. The contrast with the first two heatwave is striking. Indeed, the first two heatwaves determined a decline in DO only while happening, with DO quickly returning to levels higher than the control. The third heatwave strongly decreased DO during its course, and slowed down its recovery in the post HW phase so that it never got back to control levels.
```{r oxygen_plot, fig.cap='Dissolved oxygen dynamics over time. The red areas show the three heatwaves. The figure shows the difference in DO between mesocosm undergoing the HWs treatment and the control (dashed line at zero).', fig.align="center", fig.height=6, fig.width=10}

 ox_plot
```

We now look specifically at how the slope of recovery changes after each HW. To do that we look at the slope of the linear regression between two subsequent time points (during and after a HW) of the difference between DO in control and HW mesocosms.
```{r oxygen_slopes, fig.cap='Change in the slope of the linear regression connecting two subsequent time point ((during and after a HW) of the difference between DO in control and HW mesocosms.', fig.align="center", fig.height=6, fig.width=10}

# Calculate mean ox for Control by day
control_bm <- ox %>% 
  filter(Treatment == "Control") %>%
  group_by(Day) %>% 
  dplyr::summarize(mean_ox_control = mean(ox, na.rm = TRUE))

# Calculate mean ox for all treatments by day and cosm
ox_all_treat <- ox %>% 
  group_by(Day, Cosm, Treatment) %>% 
  dplyr::summarize(mean_ox = mean(ox, na.rm = TRUE))

# Merge the control and treatment data
ox_merged <- merge(ox_all_treat, control_bm, by = "Day")

# Remove Day -4
ox_merged <- ox_merged %>% 
  filter(Day != -4)

# Calculate the difference between HW and control
ox_merged <- ox_merged %>% 
  mutate(diff = mean_ox - mean_ox_control)

# Filter HW data
hw_data <- ox_merged %>% filter(Treatment == "HW")

# Add a range column to hw_data with the correct order
hw_data <- hw_data %>% 
  mutate(range = case_when(
    Day >= 3 & Day <= 10 ~ "3 - 10",
    Day >= 15 & Day <= 24 ~ "15 - 24",
    Day >= 30 & Day <= 38 ~ "30 - 38",
    TRUE ~ NA_character_
  )) %>%
  filter(!is.na(range))

# Set the order of the range levels
hw_data$range <- factor(hw_data$range, levels = c("3 - 10", "15 - 24", "30 - 38"))

# Function to fit linear model
fit_lm <- function(data) {
  lm_model <- lm(diff ~ Day, data = data)
  return(lm_model)
}

# Apply function to each day range and store models
lm_models <- hw_data %>%
  group_by(range) %>%
  do(model = fit_lm(.))

# Extract slopes
slopes <- lm_models %>%
  rowwise() %>%
  mutate(slope = coef(model)["Day"]) %>%
  select(range, slope) %>%
  ungroup()

# Create a combined plot
combined_plot <- ggplot(hw_data, aes(x = Day, y = diff)) +
  geom_point(aes(color = as.factor(Cosm)), size = 3) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Day", y = "Difference (HW - Control)") +
  theme_bw(base_size = 22) +
  theme(legend.position = "none") +
  facet_wrap(~ range, scales = "free", ncol = 3) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5)) +  # Ensures integer breaks on x-axis
  labs(tag = "(b)")

# Add slope annotations
combined_plot <- combined_plot +
  geom_text(data = slopes, aes(x = Inf, y = Inf, label = paste0("Slope: ", round(slope, 3))), 
            hjust = 1.5, vjust = 1.2, size = 4)

print(combined_plot)
```

Summary plot for the manuscript

```{r oxy_combined, fig.cap='combined plot for manuscript', fig.align="center", fig.height=10, fig.width=12}

oxy_combined <- ox_plot / combined_plot
oxy_combined
```

Creating model for oxygen
```{r echo=TRUE, include=TRUE}

model_ox <- lmer(log(ox) ~ Treatment * Day + (1 | Cosm), data = ox)
```

Model diagnostics
```{r check_ox_model, fig.cap= 'Checking assumption for oxygen model', fig.align="center", fig.height=12, fig.width=10}

check_model(model_ox)
```
Not bad.


```{r}
# Create a tidy summary
tidy_summary <- tidy(model_ox)

# Calculate 95% confidence intervals
conf_intervals <- confint(model_ox, level = 0.95)

# Convert conf_intervals to a data frame and set appropriate column names
conf_intervals_df <- as.data.frame(conf_intervals)
conf_intervals_df <- conf_intervals_df[-1, ] # Remove the first row which is the random effect variance
colnames(conf_intervals_df) <- c("2.5%", "97.5%")

# Add the confidence intervals to the tidy summary
tidy_summary <- cbind(tidy_summary[c(1:4), ], conf_intervals_df[ c(2:5), ])

# Print the summary in RMarkdown with kableExtra for formatting
tidy_summary %>%
  mutate(across(where(is.numeric), ~ round(., 3))) %>%
  kable(format = "html", escape = FALSE) %>%
  kable_styling(full_width = FALSE)
```

```{r}
# Save the tidy summary to a Word document
tidy_summary <- tidy_summary %>%
  mutate(across(where(is.numeric), ~ round(., 3)))

# Create a flextable object
ft <- flextable(tidy_summary)

# Set properties for the flextable (optional)
ft <- ft %>%
  set_table_properties(width = 1, layout = "autofit") %>%
  align(align = "center", part = "all") %>%
  bold(part = "header") %>%
  autofit()

# Save the flextable as a Word document
doc <- read_docx()
doc <- body_add_flextable(doc, value = ft)
print(doc, target = "Tables/ox_model_summary.docx")
```




Post - hoc analysis. Let see when the HW treatment had a significant impact on phyto abundance
```{r}

# Specify the days you are interested in for post-hoc comparisons
days_of_interest <- unique(ox$Day)  # You can also specify specific days manually, e.g., c(1, 5, 10, 15)

# Perform post-hoc analysis with specified days
emm_ox <- emmeans(model_ox, ~ Treatment | Day, at = list(Day = days_of_interest))
post_hoc_results_ox <- pairs(emm_ox)
# Convert post_hoc_results to a data frame
post_hoc_df_ox <- as.data.frame(post_hoc_results_ox)

# Order the results by the 'Day' column
post_hoc_df_ox <- post_hoc_df_ox %>% arrange(Day)

# Print the results using kable with limited number of decimals
kable(post_hoc_df_ox  %>% mutate_if(is.numeric, ~round(., 3)), format = "html") %>%
  kable_styling(full_width = FALSE) %>%
  column_spec(1, bold = TRUE)   %>% 
  column_spec(7, bold = ifelse(post_hoc_df_ox$p.value < 0.05, TRUE, FALSE))
```


```{r results='hide', echo=FALSE}
# Save table for word document
post_hoc_df_ox <- post_hoc_df_ox %>%
  mutate(across(where(is.numeric), ~ round(., 3)))
# Apply formatting to p-value column
post_hoc_df_ox <- post_hoc_df_ox %>%
  mutate(p_value = ifelse(p.value < 0.05, paste0("<b>", round(p.value, 3), "</b>"), round(p.value, 3)))

# Create a flextable object from the data frame
ft <- flextable(post_hoc_df_ox) 

# Set properties for the flextable (optional)
ft <- flextable(post_hoc_df_ox) %>%
  set_table_properties(width = 1, layout = "autofit") %>%
  align(align = "center", part = "all") %>%
  bold(part = "header") %>%
  autofit()

# Save the flextable as a Word document
doc <- read_docx()
doc <- body_add_flextable(doc, value = ft)
print(doc, target = "Tables/Ox_table_output.docx")

```

Visualization of model prediction (linear trend)
```{r}

# Visualization 
emmip(model_ox, Treatment ~ Day, at = list(Day = days_of_interest), CIs = TRUE)

```

### Chlorophyll - a
```{r results='hide', echo = FALSE}


chla <- read.csv("data/chla.csv")




# Calculate mean abundance and standard error for Control
control_mean <- chla %>% filter(Treatment == "Control") %>%
  group_by(Day) %>%
  summarize(control_mean_chla = mean(chla, na.rm = TRUE))

# Calculate differences from Control for each treatment
tot.chla_diff <- chla %>%
  left_join(control_mean, by = "Day") %>%
  mutate(diff_chla = chla - control_mean_chla)

# Summarize the data for plotting
tot_chla_dynamics <- tot.chla_diff %>%
  group_by(Treatment, Day) %>%
  summarize(mean_diff_chla = mean(diff_chla, na.rm = TRUE), se = se(diff_chla)) %>%
  mutate(lower_y = mean_diff_chla - se, upper_y = mean_diff_chla + se)

# Determine the y-axis limits to ensure alignment of zero line
y_limits <- range(tot_chla_dynamics$mean_diff_chla + tot_chla_dynamics$se, 
                  tot_chla_dynamics$mean_diff_chla - tot_chla_dynamics$se)

# Filter out the control treatment for the plot
tot_chla_dynamics_filtered <- tot_chla_dynamics %>% filter(Treatment == "HW")

# Plot the data with faceting and aligned y-axis

chla_plot <- ggplot(tot_chla_dynamics_filtered, aes(x = Day, y = mean_diff_chla, color = Treatment, fill = Treatment)) +
  geom_line(aes(group = Treatment), size = 1, color = "blue") +
  geom_point(size = 2, color = "blue") +
  geom_ribbon(aes(ymin = lower_y, ymax = upper_y, group = Treatment), alpha = 0.1, show.legend = FALSE, fill = "blue", color = "blue") +
  ylab("Chlorophyll - a \nDifference in µg/L") +
  xlab("Day") +
  viridis::scale_colour_viridis(name = "Treatment", discrete = TRUE, end = 0.8, begin = 0.1, option = "inferno") +
  viridis::scale_fill_viridis(name = "Treatment", discrete = TRUE, end = 0.8, begin = 0.1, option = "inferno") +
  scale_x_continuous(limits = c(-5, 40)) +
  theme_bw() +
  theme(legend.position = "none",                   # Remove legend
        text = element_text(size = 20),             # Increase text size for all text elements
        axis.title = element_text(size = 22),       # Increase axis title size
        plot.title = element_text(size = 24),       # Increase plot title size
        axis.text = element_text(size = 20),        # Increase axis text size
        axis.line = element_line(size = 0.5),       # Adjust axis line thickness
        panel.grid.major = element_blank(),         # Remove major gridlines
        panel.grid.minor = element_blank(),         # Remove minor gridlines
        panel.border = element_blank(),            # Remove panel borders
        panel.background = element_blank()) +      # Remove panel background

  geom_hline(yintercept = 0, linetype = "dashed") +
  coord_cartesian(ylim = y_limits) + 
  annotate("rect", xmin = 0, xmax = 6, ymin = -Inf, ymax = Inf, alpha = 0.3, fill = "red") +
  annotate("rect", xmin = 14, xmax = 20, ymin = -Inf, ymax = Inf, alpha = 0.3, fill = "red") +
  annotate("rect", xmin = 28, xmax = 34, ymin = -Inf, ymax = Inf, alpha = 0.3, fill = "red") + labs(tag = "(a)")


```

Chlorophyll - a shows probably the most dramatic response. There is not much change happening until the third heatwave, which determines a drop in chlorphyll - a. This strong decline reflect the compositional change and especially the reduction in biomass. 

```{r chlorophyll_plot, fig.cap='CHlorophyll-a dynamics over time. The red areas show the three heatwaves', fig.align="center", fig.height=6, fig.width=10}


 chla_plot
```


We now look specifically at how the slope of recovery changes after each HW. To do that we look at the slope of the linear regression between two subsequent time points (during and after a HW) of the difference between chlorophyll - a concentration in control and HW mesocosms.
```{r chla_slopes, fig.cap='Change in the slope of the linear regression connecting two subsequent time point (during and after a HW) of the difference between chlorophyll - a concentration in control and HW mesocosms.', fig.align="center", fig.height=6, fig.width=10}

# Calculate mean chla for Control by day
control_bm <- chla %>% 
  filter(Treatment == "Control") %>%
  group_by(Day) %>% 
  dplyr::summarize(mean_chla_control = mean(chla, na.rm = TRUE))

# Calculate mean chla for all treatments by day and cosm
chla_all_treat <- chla %>% 
  group_by(Day, Cosm, Treatment) %>% 
  dplyr::summarize(mean_chla = mean(chla, na.rm = TRUE))

# Merge the control and treatment data
chla_merged <- merge(chla_all_treat, control_bm, by = "Day")

# Remove Day -4
chla_merged <- chla_merged %>% 
  filter(Day != -4)

# Calculate the difference between HW and control
chla_merged <- chla_merged %>% 
  mutate(diff = mean_chla - mean_chla_control)

# Filter HW data
hw_data <- chla_merged %>% filter(Treatment == "HW")

# Define day ranges
day_ranges <- list(c(3, 10), c(15, 24), c(30, 38))

# Add a range column to hw_data with the correct order
hw_data <- hw_data %>% 
  mutate(range = case_when(
    Day >= 3 & Day <= 10 ~ "3 - 10",
    Day >= 15 & Day <= 24 ~ "15 - 24",
    Day >= 30 & Day <= 38 ~ "30 - 38",
    TRUE ~ NA_character_
  )) %>%
  filter(!is.na(range))

# Set the order of the range levels
hw_data$range <- factor(hw_data$range, levels = c("3 - 10", "15 - 24", "30 - 38"))

# Function to fit linear model
fit_lm <- function(data) {
  lm_model <- lm(diff ~ Day, data = data)
  return(lm_model)
}

# Apply function to each day range and store models
lm_models <- hw_data %>%
  group_by(range) %>%
  do(model = fit_lm(.))

# Extract slopes
slopes <- lm_models %>%
  rowwise() %>%
  mutate(slope = coef(model)["Day"]) %>%
  select(range, slope) %>%
  ungroup()

# Create a combined plot
combined_plot <- ggplot(hw_data, aes(x = Day, y = diff)) +
  geom_point(aes(color = as.factor(Cosm)), size = 3) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Day", y = "Difference (HW - Control)") +
  theme_bw(base_size = 22) +
  theme(legend.position = "none") +
  facet_wrap(~ range, scales = "free", ncol = 3) + 
  labs(tag = "(b)")

# Add slope annotations
combined_plot <- combined_plot +
  geom_text(data = slopes, aes(x = Inf, y = Inf, label = paste0("Slope: ", round(slope, 3))), 
            hjust = 1.5, vjust = 1.2, size = 5)

print(combined_plot)
```
Summary plot for the manuscript
```{r chla_combined, fig.cap='combined plot for manuscript', fig.align="center", fig.height=10, fig.width=12}
chla_combined <- chla_plot / combined_plot
chla_combined
```


Creating model for chla
```{r echo=TRUE, include=TRUE}

model_chla <- lmer(log(chla) ~ Treatment * Day + (1 | Cosm), data = chla)
```

```{r}
# Create a tidy summary
tidy_summary <- tidy(model_chla)

# Calculate 95% confidence intervals
conf_intervals <- confint(model_chla, level = 0.95)

# Convert conf_intervals to a data frame and set appropriate column names
conf_intervals_df <- as.data.frame(conf_intervals)
conf_intervals_df <- conf_intervals_df[-1, ] # Remove the first row which is the random effect variance
colnames(conf_intervals_df) <- c("2.5%", "97.5%")

# Add the confidence intervals to the tidy summary
tidy_summary <- cbind(tidy_summary[c(1:4), ], conf_intervals_df[ c(2:5), ])

# Print the summary in RMarkdown with kableExtra for formatting
tidy_summary %>%
  mutate(across(where(is.numeric), ~ round(., 3))) %>%
  kable(format = "html", escape = FALSE) %>%
  kable_styling(full_width = FALSE)
```


```{r}
# Save the tidy summary to a Word document
tidy_summary <- tidy_summary %>%
  mutate(across(where(is.numeric), ~ round(., 3)))

# Create a flextable object
ft <- flextable(tidy_summary)

# Set properties for the flextable (optional)
ft <- ft %>%
  set_table_properties(width = 1, layout = "autofit") %>%
  align(align = "center", part = "all") %>%
  bold(part = "header") %>%
  autofit()

# Save the flextable as a Word document
doc <- read_docx()
doc <- body_add_flextable(doc, value = ft)
print(doc, target = "Tables/chla_model_summary.docx")
```


Model diagnostics
```{r check_chla_model, fig.cap= 'Checking assumption for chlorophyll - a model', fig.align="center", fig.height=12, fig.width=10}

check_model(model_chla)
```
Not too bad, but homogeneity of variance a bit messy. Consider transformation.


Post - hoc analysis. Let see when the HW treatment had a significant impact on phyto abundance
```{r}
# Specify the days you are interested in for post-hoc comparisons
days_of_interest <- unique(chla$Day)  # You can also specify specific days manually, e.g., c(1, 5, 10, 15)

# Perform post-hoc analysis with specified days
emm_chla <- emmeans(model_chla, ~ Treatment | Day, at = list(Day = days_of_interest))
post_hoc_results_chla <- pairs(emm_chla)
# Convert post_hoc_results to a data frame
post_hoc_df_chla <- as.data.frame(post_hoc_results_chla)

# Order the results by the 'Day' column
post_hoc_df_chla <- post_hoc_df_chla %>% arrange(Day)

# Print the results using kable with limited number of decimals and additional formatting
kable(post_hoc_df_chla %>% mutate_if(is.numeric, ~round(., 3)), format = "html") %>%
  kable_styling(full_width = FALSE) %>%
  column_spec(1, bold = TRUE)  %>% 
  column_spec(7, bold = ifelse(post_hoc_df_chla$p.value < 0.05, TRUE, FALSE))
```
As expected from the plot, the estimate increases with time, and there is a big jump from day 31 to 38, corresponding to the drop in chla.

```{r results='hide', echo=FALSE}
# Save table for word document

post_hoc_df_chla <- post_hoc_df_chla %>%
  mutate(across(where(is.numeric), ~ round(., 3)))
# Apply formatting to p-value column
post_hoc_df_chla <- post_hoc_df_chla %>%
  mutate(p_value = ifelse(p.value < 0.05, paste0("<b>", round(p.value, 3), "</b>"), round(p.value, 3)))

# Create a flextable object from the data frame
ft <- flextable(post_hoc_df_chla)

# Set properties for the flextable (optional)
ft <- flextable(post_hoc_df_chla) %>%
  set_table_properties(width = 1, layout = "autofit") %>%
  align(align = "center", part = "all") %>%
  bold(part = "header") %>%
  autofit()

# Save the flextable as a Word document
doc <- read_docx()
doc <- body_add_flextable(doc, value = ft)
print(doc, target = "Tables/Chla_table_output.docx")

```


Visualization of model prediction (linear trend)
```{r}

# Visualization 
emmip(model_chla, Treatment ~ Day, at = list(Day = days_of_interest), CIs = TRUE)

```

## Compositional dynamics

### Relative biomass 
Now we want to see if this gradual decline in oxygen and chla is related to taxonomic differences. 
We start looking at the relative biomass of different phytoplankton group over time


Let's have a look at how different taxonomic groups of phytoplankton change over time in terms of relative biomass 
```{r results='hide', echo = FALSE, warning=FALSE}
# load group data

group_bio <- read.csv("data/group_bio.csv")

# Calculate relative abundance
group_bio2 <- group_bio %>%
  group_by( Treatment, Day) %>%
  mutate(total = sum(total_biomass)) %>%
  mutate(relative_bio = total_biomass / total * 100) %>%
  ungroup() 



```

The relative abundance of different groups changes largely over time, and may align with the drop in ecosystem functioning endpoints. 
```{r relative_abundance_plot, fig.cap='Change in relative abundance of phytoplankton groups over time in the control and heatwave treatment', fig.align="center", fig.height=20, fig.width=25}

# Ensure Treatment is a factor
group_bio2$Treatment <- as.factor(group_bio2$Treatment)

# Create the plot
p <- ggplot(group_bio2, aes(x = Treatment, y = relative_bio, fill = group)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ paste("Day", Day), scales = "free_x") +  # Include "Day" before the Day number
  labs(x = "", y = "Relative Biomass (%)") +
  theme_bw(base_size = 20) +
  theme(
    panel.background = element_rect(fill = "white", colour = "black"),  # Set panel background
    plot.title = element_text(hjust = 0.5, margin = margin(b = 20), size = 20, face = "bold"),  # Set plot title text size and make it bold
    axis.text = element_text(size = 30),  # Set axis text size
    axis.title = element_text(size = 30),  # Set axis title text size
    strip.text = element_text(size = 30),  # Set facet strip text size
    legend.text = element_text(size = 30),  # Set legend text size
    legend.title = element_text(size = 30),  # Set legend title text size
    legend.key.size = unit(1.5, "lines"),  # Increase legend key size
    legend.position = "bottom",  # Move legend to the bottom
    legend.justification = "center",  # Center justify the legend
    legend.direction = "horizontal",  # Arrange legend items horizontally
    legend.box = "vertical",  # Align legend items vertically within the box
    axis.text.x = element_text(hjust = 1)  # Rotate x-axis text
  ) +
  scale_fill_brewer(palette = "Set1")  # Apply a ColorBrewer palette


# Display the plot
print(p)


```




we now look if this visual turnover in relative groups biomass is statistically significant

### PERMANOVA

```{r results='hide', echo=FALSE, warning=FALSE}


wide_data <- group_bio %>%
  pivot_wider(
    names_from = group,
    values_from = total_biomass)  # Fill missing values with 0
  


group_bio_wide <- as.data.frame(wide_data)


set.seed(258)
# PERMANOVA per day
day_results <- lapply(unique(group_bio_wide$Day), function(day) {
  subset_data <- group_bio_wide %>% filter(Day == day)
  species_data <- subset_data[, 4:ncol(subset_data)]  # Extract species abundance columns
  bray_curtis_dist <- vegdist(species_data, method = "bray", binary = FALSE, na.rm = TRUE)  # Calculate Bray-Curtis dissimilarity
  adonis_result <- adonis(bray_curtis_dist ~ Treatment, data = subset_data, permutations = 999)
  result <- list(Day = day, PERMANOVA_result = adonis_result)
  print(result)
  return(result)
})

```

```{r echo=FALSE,  warning=FALSE}

# Prepare data for nice printing
day_results_df <- lapply(day_results, function(res) {
  if (!is.null(res$PERMANOVA_result$aov.tab)) {
    data.frame(
      Day = res$Day,
      F = res$PERMANOVA_result$aov.tab$F.Model[1],
      R2 = res$PERMANOVA_result$aov.tab$R2[1],
      p_value = res$PERMANOVA_result$aov.tab$`Pr(>F)`[1]
    )
  } else {
    data.frame(
      Day = res$Day,
      F = NA,
      R2 = NA,
      p_value = NA
    )
  }
}) %>%
  bind_rows() %>%
  arrange(Day)


# Print the results using kable with limited number of decimals and additional formatting
kable(day_results_df, format = "html") %>%
  kable_styling(full_width = FALSE) %>%
  column_spec(4, bold = ifelse(day_results_df$p_value < 0.05, TRUE, FALSE))  # Make p-value column bold if significant

```

Significant differences on day 2, 10, 30, and 38

```{r results='hide', echo=FALSE}
# Save table for word document

day_results_df <- day_results_df %>%
  mutate(across(where(is.numeric), ~ round(., 3)))
# Apply formatting to p-value column
day_results_df <- day_results_df %>%
  mutate(p_value = ifelse(p_value < 0.05, paste0("<b>", round(p_value, 3), "</b>"), round(p_value, 3)))

# Create a flextable object from the data frame
ft <- flextable(day_results_df)

# Set properties for the flextable (optional)
ft <- flextable(day_results_df) %>%
  set_table_properties(width = 1, layout = "autofit") %>%
  align(align = "center", part = "all") %>%
  bold(part = "header") %>%
  autofit()

# Save the flextable as a Word document
doc <- read_docx()
doc <- body_add_flextable(doc, value = ft)
print(doc, target = "Tables/PEROMANOVA_table_output.docx")

```

### SIMPER

SIMPER analysis - results and biomass comparison by day


```{r results='hide', echo=FALSE, warning=FALSE}


# Transform data to wide format
wide_data <- group_bio %>%
  pivot_wider(names_from = group, values_from = total_biomass, values_fill = list(total_biomass = 0))

group_bio_wide <- as.data.frame(wide_data)

# Function to perform SIMPER per day
simper_results <- lapply(unique(group_bio_wide$Day), function(day) {
  subset_data <- group_bio_wide %>% filter(Day == day)
  species_data <- subset_data[, 4:ncol(subset_data)]  # Extract species abundance columns
  
  # Perform SIMPER analysis
  simper_result <- with(subset_data, simper(species_data, Treatment))
  
  # Extract mean abundances per treatment
  mean_abundances <- subset_data %>%
    group_by(Treatment) %>%
    summarise(across(everything(), mean, na.rm = TRUE))
  
  result <- list(Day = day, SIMPER_result = summary(simper_result), Mean_Abundances = mean_abundances)
  
  return(result)
})


```

Table results Day -4 
```{r results='hide', echo=FALSE, warning=FALSE}


# Day -4 SIMPER results
day_m4_simper <- simper_results[[1]]$SIMPER_result

# Extract SIMPER results for a specific comparison (e.g., "HW_Control")
simper_table <- day_m4_simper$HW_Control

# Convert to a data frame for better formatting
simper_df <- as.data.frame(simper_table)

# Round the numeric columns to a maximum of three decimals
simper_df[] <- lapply(simper_df, function(x) if (is.numeric(x)) round(x, 3) else x)

# Add a column for species names
simper_df <- cbind(species = rownames(simper_df), simper_df)

# Print SIMPER results in HTML format using kableExtra (for previewing, optional)
simper_table_html <- simper_df %>%
  kable(format = "html", digits = 3, caption = "SIMPER Analysis Results for Day -4: HW vs Control") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

# Prepare species abundance comparison (example data)
species_abundance_comparison <- data.frame(
  species = rownames(simper_df),
  HW_abundance = runif(nrow(simper_df), min = 1, max = 100),  # Replace with actual data
  Control_abundance = runif(nrow(simper_df), min = 1, max = 100)  # Replace with actual data
)

# Round numeric columns in species Biomass comparison
species_abundance_comparison[] <- lapply(species_abundance_comparison, function(x) if (is.numeric(x)) round(x, 3) else x)

# Print species abundance comparison in HTML format using kableExtra (for previewing, optional)
species_abundance_html <- species_abundance_comparison %>%
  kable(format = "html", digits = 3, caption = "Species Biomass Comparison for Day -4: HW vs Control") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))


# Convert SIMPER results to flextable
ft_simper <- flextable(simper_df)



# Convert species Biomass comparison to flextable
ft_species_abundance <- flextable(species_abundance_comparison)



# Create a new Word document
doc <- read_docx() %>%
  body_add_par("SIMPER Analysis Results for Day -4: HW vs Control", style = "heading 1") %>%
  body_add_flextable(ft_simper) %>%
  body_add_par("") %>%
  body_add_par("Species Biomass Comparison for Day -4: HW vs Control", style = "heading 1") %>%
  body_add_flextable(ft_species_abundance)

# Save the document
print(doc, target = "Tables/SIMPER_Results_Day_m4_with_comparison.docx")




```

```{r}
simper_table_html
```



Table results Day 3
```{r results='hide', echo=FALSE, warning=FALSE}


# Day -4 SIMPER results
day_3_simper <- simper_results[[2]]$SIMPER_result

# Extract SIMPER results for a specific comparison (e.g., "HW_Control")
simper_table <- day_3_simper$HW_Control

# Convert to a data frame for better formatting
simper_df <- as.data.frame(simper_table)

# Round the numeric columns to a maximum of three decimals
simper_df[] <- lapply(simper_df, function(x) if (is.numeric(x)) round(x, 3) else x)

# Add a column for species names
simper_df <- cbind(species = rownames(simper_df), simper_df)

# Print SIMPER results in HTML format using kableExtra (for previewing, optional)
simper_table_html <- simper_df %>%
  kable(format = "html", digits = 3, caption = "SIMPER Analysis Results for Day 3: HW vs Control") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

# Prepare species abundance comparison (example data)
species_abundance_comparison <- data.frame(
  species = rownames(simper_df),
  HW_abundance = runif(nrow(simper_df), min = 1, max = 100),  # Replace with actual data
  Control_abundance = runif(nrow(simper_df), min = 1, max = 100)  # Replace with actual data
)

# Round numeric columns in species Biomass comparison
species_abundance_comparison[] <- lapply(species_abundance_comparison, function(x) if (is.numeric(x)) round(x, 3) else x)

# Print species abundance comparison in HTML format using kableExtra (for previewing, optional)
species_abundance_html <- species_abundance_comparison %>%
  kable(format = "html", digits = 3, caption = "Species Biomass Comparison for Day 3: HW vs Control") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))


# Convert SIMPER results to flextable
ft_simper <- flextable(simper_df)


# Convert species Biomass comparison to flextable
ft_species_abundance <- flextable(species_abundance_comparison)


# Create a new Word document
doc <- read_docx() %>%
  body_add_par("SIMPER Analysis Results for Day 3: HW vs Control", style = "heading 1") %>%
  body_add_flextable(ft_simper) %>%
  body_add_par("") %>%
  body_add_par("Species Biomass Comparison for Day 3: HW vs Control", style = "heading 1") %>%
  body_add_flextable(ft_species_abundance)

# Save the document
print(doc, target = "Tables/SIMPER_Results_Day_3_with_comparison.docx")




```

```{r}
simper_table_html
```



Table results Day 10
```{r results='hide', echo=FALSE, warning=FALSE}


# Day 10 SIMPER results
day_10_simper <- simper_results[[3]]$SIMPER_result

# Extract SIMPER results for a specific comparison (e.g., "HW_Control")
simper_table <- day_10_simper$HW_Control

# Convert to a data frame for better formatting
simper_df <- as.data.frame(simper_table)

# Round the numeric columns to a maximum of three decimals
simper_df[] <- lapply(simper_df, function(x) if (is.numeric(x)) round(x, 3) else x)

# Add a column for species names
simper_df <- cbind(species = rownames(simper_df), simper_df)

# Print SIMPER results in HTML format using kableExtra (for previewing, optional)
simper_table_html <- simper_df %>%
  kable(format = "html", digits = 3, caption = "SIMPER Analysis Results for Day 10: HW vs Control") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

# Prepare species abundance comparison (example data)
species_abundance_comparison <- data.frame(
  species = rownames(simper_df),
  HW_abundance = runif(nrow(simper_df), min = 1, max = 100),  # Replace with actual data
  Control_abundance = runif(nrow(simper_df), min = 1, max = 100)  # Replace with actual data
)

# Round numeric columns in species Biomass comparison
species_abundance_comparison[] <- lapply(species_abundance_comparison, function(x) if (is.numeric(x)) round(x, 3) else x)

# Print species abundance comparison in HTML format using kableExtra (for previewing, optional)
species_abundance_html <- species_abundance_comparison %>%
  kable(format = "html", digits = 3, caption = "Species Biomass Comparison for Day 10: HW vs Control") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))


# Convert SIMPER results to flextable
ft_simper <- flextable(simper_df)


# Convert species Biomass comparison to flextable
ft_species_abundance <- flextable(species_abundance_comparison)


# Create a new Word document
doc <- read_docx() %>%
  body_add_par("SIMPER Analysis Results for Day 10: HW vs Control", style = "heading 1") %>%
  body_add_flextable(ft_simper) %>%
  body_add_par("") %>%
  body_add_par("Species Biomass Comparison for Day 10: HW vs Control", style = "heading 1") %>%
  body_add_flextable(ft_species_abundance)

# Save the document
print(doc, target = "Tables/SIMPER_Results_Day_10_with_comparison.docx")




```

```{r}
simper_table_html
```



Table results Day 15
```{r results='hide', echo=FALSE, warning=FALSE}


# Day 15 SIMPER results
day_15_simper <- simper_results[[4]]$SIMPER_result

# Extract SIMPER results for a specific comparison (e.g., "HW_Control")
simper_table <- day_15_simper$HW_Control

# Convert to a data frame for better formatting
simper_df <- as.data.frame(simper_table)

# Round the numeric columns to a maximum of three decimals
simper_df[] <- lapply(simper_df, function(x) if (is.numeric(x)) round(x, 3) else x)

# Add a column for species names
simper_df <- cbind(species = rownames(simper_df), simper_df)

# Print SIMPER results in HTML format using kableExtra (for previewing, optional)
simper_table_html <- simper_df %>%
  kable(format = "html", digits = 3, caption = "SIMPER Analysis Results for Day 15: HW vs Control") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

# Prepare species abundance comparison (example data)
species_abundance_comparison <- data.frame(
  species = rownames(simper_df),
  HW_abundance = runif(nrow(simper_df), min = 1, max = 100),  # Replace with actual data
  Control_abundance = runif(nrow(simper_df), min = 1, max = 100)  # Replace with actual data
)

# Round numeric columns in species Biomass comparison
species_abundance_comparison[] <- lapply(species_abundance_comparison, function(x) if (is.numeric(x)) round(x, 3) else x)

# Print species abundance comparison in HTML format using kableExtra (for previewing, optional)
species_abundance_html <- species_abundance_comparison %>%
  kable(format = "html", digits = 3, caption = "Species Biomass Comparison for Day 15: HW vs Control") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))


# Convert SIMPER results to flextable
ft_simper <- flextable(simper_df)


# Convert species Biomass comparison to flextable
ft_species_abundance <- flextable(species_abundance_comparison)


# Create a new Word document
doc <- read_docx() %>%
  body_add_par("SIMPER Analysis Results for Day 15: HW vs Control", style = "heading 1") %>%
  body_add_flextable(ft_simper) %>%
  body_add_par("") %>%
  body_add_par("Species Biomass Comparison for Day 15: HW vs Control", style = "heading 1") %>%
  body_add_flextable(ft_species_abundance)

# Save the document
print(doc, target = "Tables/SIMPER_Results_Day_15_with_comparison.docx")




```

```{r}
simper_table_html
```



Table results Day 24
```{r results='hide', echo=FALSE, warning=FALSE}


# Day 15 SIMPER results
day_24_simper <- simper_results[[5]]$SIMPER_result

# Extract SIMPER results for a specific comparison (e.g., "HW_Control")
simper_table <- day_24_simper$HW_Control

# Convert to a data frame for better formatting
simper_df <- as.data.frame(simper_table)

# Round the numeric columns to a maximum of three decimals
simper_df[] <- lapply(simper_df, function(x) if (is.numeric(x)) round(x, 3) else x)

# Add a column for species names
simper_df <- cbind(species = rownames(simper_df), simper_df)

# Print SIMPER results in HTML format using kableExtra (for previewing, optional)
simper_table_html <- simper_df %>%
  kable(format = "html", digits = 3, caption = "SIMPER Analysis Results for Day 24: HW vs Control") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

# Prepare species abundance comparison (example data)
species_abundance_comparison <- data.frame(
  species = rownames(simper_df),
  HW_abundance = runif(nrow(simper_df), min = 1, max = 100),  # Replace with actual data
  Control_abundance = runif(nrow(simper_df), min = 1, max = 100)  # Replace with actual data
)

# Round numeric columns in species Biomass comparison
species_abundance_comparison[] <- lapply(species_abundance_comparison, function(x) if (is.numeric(x)) round(x, 3) else x)

# Print species abundance comparison in HTML format using kableExtra (for previewing, optional)
species_abundance_html <- species_abundance_comparison %>%
  kable(format = "html", digits = 3, caption = "Species Biomass Comparison for Day 24: HW vs Control") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))


# Convert SIMPER results to flextable
ft_simper <- flextable(simper_df)


# Convert species Biomass comparison to flextable
ft_species_abundance <- flextable(species_abundance_comparison)


# Create a new Word document
doc <- read_docx() %>%
  body_add_par("SIMPER Analysis Results for Day 24: HW vs Control", style = "heading 1") %>%
  body_add_flextable(ft_simper) %>%
  body_add_par("") %>%
  body_add_par("Species Biomass Comparison for Day 24: HW vs Control", style = "heading 1") %>%
  body_add_flextable(ft_species_abundance)

# Save the document
print(doc, target = "Tables/SIMPER_Results_Day_24_with_comparison.docx")




```

```{r}
simper_table_html
```



Table results Day 30
```{r results='hide', echo=FALSE, warning=FALSE}


# Day 15 SIMPER results
day_30_simper <- simper_results[[6]]$SIMPER_result

# Extract SIMPER results for a specific comparison (e.g., "HW_Control")
simper_table <- day_30_simper$HW_Control

# Convert to a data frame for better formatting
simper_df <- as.data.frame(simper_table)

# Round the numeric columns to a maximum of three decimals
simper_df[] <- lapply(simper_df, function(x) if (is.numeric(x)) round(x, 3) else x)

# Add a column for species names
simper_df <- cbind(species = rownames(simper_df), simper_df)

# Print SIMPER results in HTML format using kableExtra (for previewing, optional)
simper_table_html <- simper_df %>%
  kable(format = "html", digits = 3, caption = "SIMPER Analysis Results for Day 30: HW vs Control") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

# Prepare species abundance comparison (example data)
species_abundance_comparison <- data.frame(
  species = rownames(simper_df),
  HW_abundance = runif(nrow(simper_df), min = 1, max = 100),  # Replace with actual data
  Control_abundance = runif(nrow(simper_df), min = 1, max = 100)  # Replace with actual data
)

# Round numeric columns in species Biomass comparison
species_abundance_comparison[] <- lapply(species_abundance_comparison, function(x) if (is.numeric(x)) round(x, 3) else x)

# Print species abundance comparison in HTML format using kableExtra (for previewing, optional)
species_abundance_html <- species_abundance_comparison %>%
  kable(format = "html", digits = 3, caption = "Species Biomass Comparison for Day 30: HW vs Control") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))


# Convert SIMPER results to flextable
ft_simper <- flextable(simper_df)


# Convert species Biomass comparison to flextable
ft_species_abundance <- flextable(species_abundance_comparison)


# Create a new Word document
doc <- read_docx() %>%
  body_add_par("SIMPER Analysis Results for Day 30: HW vs Control", style = "heading 1") %>%
  body_add_flextable(ft_simper) %>%
  body_add_par("") %>%
  body_add_par("Species Biomass Comparison for Day 30: HW vs Control", style = "heading 1") %>%
  body_add_flextable(ft_species_abundance)

# Save the document
print(doc, target = "Tables/SIMPER_Results_Day_30_with_comparison.docx")




```

```{r}
simper_table_html
```



Table results Day 38
```{r results='hide', echo=FALSE, warning=FALSE}


# Day 15 SIMPER results
day_38_simper <- simper_results[[7]]$SIMPER_result

# Extract SIMPER results for a specific comparison (e.g., "HW_Control")
simper_table <- day_38_simper$HW_Control

# Convert to a data frame for better formatting
simper_df <- as.data.frame(simper_table)

# Round the numeric columns to a maximum of three decimals
simper_df[] <- lapply(simper_df, function(x) if (is.numeric(x)) round(x, 3) else x)

# Add a column for species names
simper_df <- cbind(species = rownames(simper_df), simper_df)

# Print SIMPER results in HTML format using kableExtra (for previewing, optional)
simper_table_html <- simper_df %>%
  kable(format = "html", digits = 3, caption = "SIMPER Analysis Results for Day 38: HW vs Control") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

# Prepare species abundance comparison (example data)
species_abundance_comparison <- data.frame(
  species = rownames(simper_df),
  HW_abundance = runif(nrow(simper_df), min = 1, max = 100),  # Replace with actual data
  Control_abundance = runif(nrow(simper_df), min = 1, max = 100)  # Replace with actual data
)

# Round numeric columns in species Biomass comparison
species_abundance_comparison[] <- lapply(species_abundance_comparison, function(x) if (is.numeric(x)) round(x, 3) else x)

# Print species abundance comparison in HTML format using kableExtra (for previewing, optional)
species_abundance_html <- species_abundance_comparison %>%
  kable(format = "html", digits = 3, caption = "Species Biomass Comparison for Day 38: HW vs Control") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))


# Convert SIMPER results to flextable
ft_simper <- flextable(simper_df)


# Convert species Biomass comparison to flextable
ft_species_abundance <- flextable(species_abundance_comparison)


# Create a new Word document
doc <- read_docx() %>%
  body_add_par("SIMPER Analysis Results for Day 38: HW vs Control", style = "heading 1") %>%
  body_add_flextable(ft_simper) %>%
  body_add_par("") %>%
  body_add_par("Species Biomass Comparison for Day 38: HW vs Control", style = "heading 1") %>%
  body_add_flextable(ft_species_abundance)

# Save the document
print(doc, target = "Tables/SIMPER_Results_Day_38_with_comparison.docx")




```

```{r}
simper_table_html
```




```{r results='hide', echo=FALSE}


group_bio_wide <- group_bio_wide[,-c(1)]

species_data <- group_bio_wide[, -(1:2)]  # Assuming the first two columns are Day and Treatment
bray_curtis_dist <- vegdist(species_data, method = "bray")

# Function to calculate NMDS and prepare data for plotting
prepare_nmds_data <- function(day_data) {
  species_data <- day_data[, -(1:2)]  # Assuming the first two columns are Day and Treatment
  bray_curtis_dist <- vegdist(species_data, method = "bray")
  nmds_result <- metaMDS(bray_curtis_dist, k = 2, trymax = 100)
  ordination_df <- as.data.frame(nmds_result$points)
  ordination_df$Treatment <- day_data$Treatment
  return(ordination_df)
}

# List to store ordination data frames for each day
ordination_list <- lapply(unique(group_bio_wide$Day), function(day) {
  day_data <- group_bio_wide %>% filter(Day == day)
  ordination_df <- prepare_nmds_data(day_data)
  ordination_df$Day <- day
  return(ordination_df)
})

# Combine all ordination data frames into one
combined_ordination_df <- do.call(rbind, ordination_list)


```

### NMDS plot
Not sure if this makes sense, as the change in relative biomass plot looks much nicer
```{r echo = FALSE, composition_plot_NMDS, fig.cap='Non-Metric Multidimensional Scaling plot of compositional dynamics over time.', fig.align="center", fig.height=12, fig.width=25}

# Define the layout for 3 rows and 5 columns
num_rows <- 3
num_cols <- 5

# Plot with polygons for each treatment
ggplot(combined_ordination_df, aes(x = MDS1, y = MDS2, fill = Treatment, group = interaction(Treatment, Day))) +
  geom_polygon(alpha = 0.5, color = "black") +
  geom_point(size = 3, aes(color = Treatment)) +
  labs(x = "NMDS Axis 1", y = "NMDS Axis 2", color = "Treatment", fill = "Treatment") +
  theme_bw(base_size = 25) +
  ggtitle("Compositional Change of Phytoplankton Community Over Time") +
  facet_wrap(~ Day, nrow = num_rows, ncol = num_cols, scales = "free")
```

